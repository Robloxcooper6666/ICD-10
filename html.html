<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 ä»£ç¢¼æŸ¥è©¢ç³»çµ±</title>
    <style>
        /* åŸæœ‰æ¨£å¼ä¿æŒä¸è®Š */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #2c3e50; border-left: 5px solid #0288d1; padding-left: 15px; }
        .stats-info { margin-bottom: 20px; font-size: 0.95em; color: #666; background: #f0f7ff; padding: 10px 15px; border-radius: 6px; border: 1px solid #d0e3f5; }
        .stats-info b { color: #0288d1; }
        input { width: 100%; padding: 14px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; border: 2px solid #eee; border-radius: 8px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #0288d1; }
        .quick-search { margin-bottom: 25px; min-height: 35px; }
        .quick-search label { font-size: 14px; color: #777; margin-right: 10px; display: block; margin-bottom: 8px; }
        .tag { display: inline-block; background: #e1f5fe; color: #0288d1; padding: 6px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; margin-right: 8px; margin-bottom: 8px; border: 1px solid #b3e5fc; transition: all 0.2s; }
        .tag:hover { background: #0288d1; color: white; transform: translateY(-1px); }

        /* æ–°å¢ï¼šæ˜Ÿæ˜Ÿæ”¶è—æŒ‰éˆ•æ¨£å¼ */
        .fav-btn { cursor: pointer; font-size: 20px; color: #ccc; transition: color 0.2s; user-select: none; }
        .fav-btn.active { color: #ffca28; }
        .fav-btn:hover { transform: scale(1.2); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 14px; text-align: left; }
        th { background-color: #fafafa; color: #666; font-weight: 600; text-transform: uppercase; font-size: 13px; }
        tr:hover { background-color: #fcfcfc; }
        .code-cell { font-family: "Courier New", monospace; font-weight: bold; color: #d81b60; }
        .no-result { color: #999; text-align: center; margin-top: 30px; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>ICD-10 ç–¾ç—…ä»£ç¢¼æŸ¥è©¢</h2>
    
    <div class="stats-info">
        ç›®å‰è³‡æ–™åº«å·²éŒ„å…¥ï¼š<span id="totalCount">è¼‰å…¥ä¸­...</span> ç­†ç–¾ç—…ä»£ç¢¼
    </div>

    <input type="text" id="searchInput" placeholder="æœå°‹ä»£ç¢¼ã€ä¸­æ–‡æˆ–è‹±æ–‡åç¨±... (æŒ‰ Enter ç´€éŒ„ç†±é–€æœå°‹)">

    <div class="quick-search" id="quickSearch">
        <label>ğŸ”¥ ç†±é–€æŸ¥è©¢ (æœå°‹è¶…é 5 æ¬¡)ï¼š</label>
        <span id="hotTags"></span>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 10%;">æ”¶è—</th>
                <th style="width: 15%;">ä»£ç¢¼</th>
                <th style="width: 37.5%;">è‹±æ–‡åç¨±</th>
                <th style="width: 37.5%;">ä¸­æ–‡åç¨±</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>
    <div id="noResult" class="no-result" style="display: none;">æ‰¾ä¸åˆ°ç›¸ç¬¦çš„çµæœï¼Œè«‹è©¦è©¦å…¶ä»–é—œéµå­—ã€‚</div>
</div>

<script>
    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icdFavorites') || '[]');
    const THRESHOLD = 5;

    const searchInput = document.getElementById('searchInput');
    const hotTagsContainer = document.getElementById('hotTags');
    const totalCountSpan = document.getElementById('totalCount');
    const resultBody = document.getElementById('resultBody');
    const noResult = document.getElementById('noResult');

    // 1. åˆå§‹åŒ–è³‡æ–™
    fetch('icd10_codes_combined.json')
        .then(response => {
            if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥ JSON æª”æ¡ˆ');
            return response.json();
        })
        .then(data => {
            icdData = data;
            totalCountSpan.innerText = icdData.length.toLocaleString();
            performSearch(''); // åˆå§‹é¡¯ç¤º
            renderHotTags();
        })
        .catch(err => {
            console.error(err);
            totalCountSpan.innerText = "è®€å–å¤±æ•—";
        });

    // 2. æœå°‹èˆ‡æ’åºæ ¸å¿ƒé‚è¼¯
    function performSearch(keyword) {
        const cleanKeyword = keyword.toLowerCase().trim();
        let filtered;

        if (cleanKeyword === '') {
            filtered = icdData.slice(0, 20); // é è¨­é¡¯ç¤ºå‰ 20 ç­†
        } else {
            filtered = icdData.filter(item =>
                item.code.toLowerCase().includes(cleanKeyword) ||
                item.en.toLowerCase().includes(cleanKeyword) ||
                item.zh.includes(cleanKeyword)
            );
        }

        // æ’åºé‚è¼¯ï¼šæ”¶è—çš„æ’åœ¨å‰é¢
        const sorted = filtered.sort((a, b) => {
            const aFav = favorites.includes(a.code) ? 1 : 0;
            const bFav = favorites.includes(b.code) ? 1 : 0;
            return bFav - aFav; // 1 (æ”¶è—) æœƒæ’åœ¨ 0 (æœªæ”¶è—) å‰é¢
        });
        
        displayResults(sorted);
    }

    // 3. æ”¶è—åˆ‡æ›åŠŸèƒ½
    function toggleFavorite(code) {
        const index = favorites.indexOf(code);
        if (index > -1) {
            favorites.splice(index, 1); // ç§»é™¤æ”¶è—
        } else {
            favorites.push(code); // åŠ å…¥æ”¶è—
        }
        localStorage.setItem('icdFavorites', JSON.stringify(favorites));
        performSearch(searchInput.value); // é‡æ–°æ¸²æŸ“ç•¶å‰åˆ—è¡¨
    }

    // 4. ç´€éŒ„ç†±é–€æœå°‹ (åŸæœ‰é‚è¼¯)
    function recordSearch(keyword) {
        const val = keyword.trim();
        if (val.length < 2) return; 
        let history = JSON.parse(localStorage.getItem('icdSearchHistory') || '{}');
        history[val] = (history[val] || 0) + 1;
        localStorage.setItem('icdSearchHistory', JSON.stringify(history));
        renderHotTags(); 
    }

    // 5. æ¸²æŸ“ç†±é–€æ¨™ç±¤ (åŸæœ‰é‚è¼¯)
    function renderHotTags() {
        const history = JSON.parse(localStorage.getItem('icdSearchHistory') || '{}');
        hotTagsContainer.innerHTML = '';
        const tags = Object.keys(history).filter(word => history[word] >= THRESHOLD);
        if (tags.length === 0) {
            hotTagsContainer.innerHTML = '<span style="color:#ccc; font-size:12px;">æš«ç„¡å¸¸ç”¨æ¨™ç±¤</span>';
            return;
        }
        tags.forEach(word => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.innerText = word;
            span.onclick = () => {
                searchInput.value = word;
                performSearch(word);
            };
            hotTagsContainer.appendChild(span);
        });
    }

    // ç›£è½è¼¸å…¥
    searchInput.addEventListener('input', (e) => performSearch(e.target.value));
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.target.value.trim() !== '') {
            recordSearch(e.target.value);
        }
    });

    // 6. æ¸²æŸ“çµæœè¡¨æ ¼ (ä¿®æ”¹ï¼šå¢åŠ æ˜Ÿæ˜ŸæŒ‰éˆ•)
    function displayResults(data) {
        resultBody.innerHTML = '';
        if (data.length === 0) {
            noResult.style.display = 'block';
            return;
        }
        noResult.style.display = 'none';

        resultBody.innerHTML = data.map(item => {
            const isFav = favorites.includes(item.code);
            return `
                <tr>
                    <td>
                        <span class="fav-btn ${isFav ? 'active' : ''}" 
                              onclick="toggleFavorite('${item.code}')">
                            ${isFav ? 'â˜…' : 'â˜†'}
                        </span>
                    </td>
                    <td class="code-cell">${item.code}</td>
                    <td>${item.en}</td>
                    <td>${item.zh}</td>
                </tr>
            `;
        }).join('');
    }
</script>

</body>
</html>

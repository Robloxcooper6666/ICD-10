<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 æ™ºæ…§åˆ†å±¤æ¨¹ç‹€ç³»çµ±V2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-deep: #0f172a;
            --card-bg: #1e293b;
            --accent: #0ea5e9;
            --text-main: #f8fafc;
            --highlight: #f472b6;
            --fav-star: #fbbf24;
        }
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', 'PingFang TC', sans-serif;
            overflow-x: hidden;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .code-font { font-family: 'JetBrains Mono', monospace; }

        .tab-active {
            background: var(--accent);
            color: white !important;
            border-radius: 0.5rem;
        }

        /* æ¨¹ç‹€åˆ†æ”¯é€£æ¥ç·š */
        .branch-line {
            position: relative;
        }
        .branch-line::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0;
            bottom: 1.5rem;
            width: 2px;
            background: #334155;
        }
        .branch-item::after {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1.2rem;
            width: 1rem;
            height: 2px;
            background: #334155;
        }

        .active-star { color: var(--fav-star) !important; text-shadow: 0 0 8px rgba(251, 191, 36, 0.4); }

        /* å­—æ¯å°èˆª */
        .letter-btn {
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .letter-btn:hover, .letter-btn.active {
            background: var(--accent);
            color: white;
        }

        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-0 flex flex-col h-screen">

<!-- é ‚éƒ¨å°è¦½åˆ— -->
<nav class="bg-slate-900 border-b border-slate-800 shrink-0 z-50 shadow-xl">
    <div class="max-w-7xl mx-auto px-6 py-3">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold text-sky-400">ICD-10 æ™ºæ…§ç³»çµ±</h1>
            <div class="flex bg-slate-800 rounded-lg p-1 gap-1">
                <button onclick="switchTab('search')" id="tabSearch" class="px-4 py-1.5 text-sm font-medium tab-active">ğŸ” æœå°‹</button>
                <button onclick="switchTab('category')" id="tabCategory" class="px-4 py-1.5 text-sm font-medium text-slate-400 hover:text-white">ğŸ—‚ï¸ é¡åˆ¥ç€è¦½</button>
                <button onclick="switchTab('favorites')" id="tabFavs" class="px-4 py-1.5 text-sm font-medium text-slate-400 hover:text-white">â­ æˆ‘çš„æœ€æ„›</button>
            </div>
        </div>
        <!-- å­—æ¯ç´¢å¼•åˆ— -->
        <div id="letterNav" class="flex flex-wrap gap-1 border-t border-slate-800 pt-3 hidden">
            <!-- A-Z å­—æ¯ç”± JS ç”Ÿæˆ -->
        </div>
    </div>
</nav>

<div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
    <div class="max-w-6xl mx-auto">

        <!-- é ç±¤ä¸€ï¼šæœå°‹é é¢ -->
        <div id="pageSearch" class="space-y-6">
            <div class="bg-[#1e293b] rounded-2xl p-6 shadow-2xl border border-slate-700">
                <input type="text" id="searchInput"
                    class="w-full bg-slate-900 border-2 border-slate-700 rounded-xl px-5 py-4 text-lg focus:outline-none focus:border-sky-500 transition-all text-white"
                    placeholder="è¼¸å…¥é—œéµå­—æˆ–ä»£ç¢¼ (å¯ç”¨ç©ºæ ¼éš”é–‹å¤šå€‹é—œéµå­—ï¼Œå¦‚ï¼šé«˜è¡€å£“ æ‡·å­•)...">
                <div id="searchTree" class="mt-8 space-y-6">
                    <!-- æœå°‹çµæœå°‡ä»¥æ¨¹ç‹€é¡¯ç¤º -->
                </div>
            </div>
        </div>

        <!-- é ç±¤äºŒï¼šé¡åˆ¥ç€è¦½ -->
        <div id="pageCategory" class="hidden animate-fadeIn space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="currentCategoryTitle" class="text-3xl font-bold text-sky-400">è«‹é¸æ“‡é–‹é ­å­—æ¯</h2>
                <div class="flex gap-4">
                    <button onclick="expandAllGroups(true)" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg border border-slate-600">å…¨éƒ¨å±•é–‹</button>
                    <button onclick="expandAllGroups(false)" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg border border-slate-600">å…¨éƒ¨æ”¶åˆ</button>
                </div>
            </div>
            <div id="categoryTree" class="space-y-8">
                <!-- æ ¹æ“šé¸æ“‡å­—æ¯ç”Ÿæˆçš„æ¨¹ç‹€åˆ†æ”¯ -->
            </div>
        </div>

        <!-- é ç±¤ä¸‰ï¼šæˆ‘çš„æœ€æ„› -->
        <div id="pageFavorites" class="hidden animate-fadeIn space-y-6">
            <div class="bg-slate-900 border-2 border-sky-500/30 rounded-2xl p-6">
                <h3 class="text-2xl font-bold text-amber-400 mb-6 flex items-center gap-2">â­ æˆ‘çš„æ”¶è—æ¸…å–®</h3>
                <div id="favList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="noFavHint" class="text-center py-20 text-slate-500">å°šç„¡æ”¶è—é …ç›®</div>
            </div>
        </div>

        <div id="loading" class="py-20 text-center text-slate-500">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-sky-500 border-t-transparent mb-4"></div>
            <p>æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...</p>
        </div>
    </div>
</div>

<!-- è¤‡è£½æç¤º -->
<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-sky-500 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 font-bold">
    å·²è¤‡è£½ä»£ç¢¼ï¼
</div>

<script>
    const DATA_URL = 'https://raw.githubusercontent.com/Robloxcooper6666/ICD-10/main/icd10_codes_combined.json';
    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icd_fav_tree_v2') || '[]');
    let currentLetter = '';

    // åˆå§‹åŒ–
    async function init() {
        try {
            const res = await fetch(DATA_URL);
            icdData = await res.json();
            document.getElementById('loading').style.display = 'none';
            initLetterNav();
            switchTab('search');
            renderFavorites();
        } catch (err) {
            document.getElementById('loading').innerText = 'è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚';
        }
    }

    // åˆå§‹åŒ– A-Z å°è¦½
    function initLetterNav() {
        const nav = document.getElementById('letterNav');
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        nav.innerHTML = letters.map(l => `
            <button onclick="selectLetter('${l}')" class="letter-btn" id="btn-letter-${l}">${l}</button>
        `).join('');
    }

    // é¸æ“‡å­—æ¯
    function selectLetter(l) {
        currentLetter = l;
        document.querySelectorAll('.letter-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-letter-${l}`).classList.add('active');
        document.getElementById('currentCategoryTitle').innerText = `é–‹é ­ç‚º ${l} çš„è¨ºæ–·é¡åˆ¥`;
        renderCategoryTree(l);
    }

    // é ç±¤åˆ‡æ›
    function switchTab(tab) {
        const pages = ['pageSearch', 'pageCategory', 'pageFavorites'];
        const tabs = ['tabSearch', 'tabCategory', 'tabFavs'];
        const letterNav = document.getElementById('letterNav');

        pages.forEach(p => document.getElementById(p).classList.add('hidden'));
        tabs.forEach(t => document.getElementById(t).classList.remove('tab-active', 'text-slate-400'));

        if (tab === 'search') {
            document.getElementById('pageSearch').classList.remove('hidden');
            document.getElementById('tabSearch').classList.add('tab-active');
            letterNav.classList.add('hidden');
        } else if (tab === 'category') {
            document.getElementById('pageCategory').classList.remove('hidden');
            document.getElementById('tabCategory').classList.add('tab-active');
            letterNav.classList.remove('hidden');
            if(!currentLetter) selectLetter('A');
        } else {
            document.getElementById('pageFavorites').classList.remove('hidden');
            document.getElementById('tabFavs').classList.add('tab-active');
            letterNav.classList.add('hidden');
            renderFavorites();
        }
    }

    // æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ï¼šæ¨¹ç‹€åˆ†æ”¯
    function buildTreeHTML(data) {
        if (data.length === 0) return '<div class="text-center py-10 text-slate-500">æŸ¥ç„¡çµæœ</div>';
        
        const groups = {};
        data.forEach(item => {
            const mainKey = item.code.split('.')[0];
            if (!groups[mainKey]) groups[mainKey] = { main: null, children: [] };
            if (item.code === mainKey) groups[mainKey].main = item;
            else groups[mainKey].children.push(item);
        });

        const sortedKeys = Object.keys(groups).sort();
        return sortedKeys.map(key => {
            const group = groups[key];
            const main = group.main || { code: key, zh: "ç›¸é—œè¨ºæ–·é …", en: "" };
            const isFav = favorites.includes(main.code);

            return `
                <div class="category-group bg-slate-800/20 rounded-2xl border border-slate-700/50 p-6 overflow-hidden">
                    <div class="flex items-center gap-4 cursor-pointer" onclick="handleAction('${main.code}', '${main.zh}')">
                        <button onclick="event.stopPropagation(); toggleFav('${main.code}')"
                                class="text-2xl text-slate-600 hover:text-amber-400 ${isFav ? 'active-star' : ''}">â˜…</button>
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-pink-400 code-font">${main.code}</h4>
                            <p class="text-slate-100 font-medium">${main.zh}</p>
                        </div>
                        <div class="text-slate-500 text-xs text-right">
                            ${group.children.length} å€‹å­ç´°é …
                        </div>
                    </div>

                    ${group.children.length > 0 ? `
                        <div class="mt-6 ml-10 space-y-4 branch-line">
                            ${group.children.map(sub => `
                                <div class="relative branch-item flex items-center gap-3 group" onclick="handleAction('${sub.code}', '${sub.zh}')">
                                    <button onclick="event.stopPropagation(); toggleFav('${sub.code}')"
                                            class="text-sm text-slate-600 hover:text-amber-400 ${favorites.includes(sub.code) ? 'active-star' : ''}">â˜…</button>
                                    <div class="bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700 group-hover:border-sky-500 transition-all cursor-pointer flex-1 flex justify-between">
                                        <div>
                                            <span class="code-font font-bold text-sky-400">${sub.code}</span>
                                            <span class="ml-3 text-slate-200">${sub.zh}</span>
                                        </div>
                                        <span class="text-[10px] text-slate-500 opacity-0 group-hover:opacity-100 italic self-center">é»æ“Šè¤‡è£½</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // é¡åˆ¥é é¢æ¸²æŸ“
    function renderCategoryTree(letter) {
        const container = document.getElementById('categoryTree');
        const filtered = icdData.filter(item => item.code.startsWith(letter));
        container.innerHTML = buildTreeHTML(filtered);
    }

    // æœå°‹é é¢æ¸²æŸ“ (åŠ å¼·ç‰ˆï¼šæ”¯æ´å¤šé—œéµå­—æœå°‹)
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        const tree = document.getElementById('searchTree');
        if (!query) { tree.innerHTML = ''; return; }

        // å°‡è¼¸å…¥å­—ä¸²ä¾ç©ºç™½åˆ†å‰²æˆå¤šå€‹é—œéµå­—
        const keywords = query.split(/\s+/).filter(k => k.length > 0);

        const filtered = icdData.filter(item => {
            const itemCode = item.code.toLowerCase();
            const itemZh = item.zh.toLowerCase();
            
            // å¿…é ˆåŒ…å«ã€Œæ‰€æœ‰ã€è¼¸å…¥çš„é—œéµå­— (äº¤é›†)
            return keywords.every(kw => 
                itemCode.includes(kw) || itemZh.includes(kw)
            );
        }).slice(0, 40); // å¢åŠ é¡¯ç¤ºä¸Šé™è‡³ 40 ç­†

        tree.innerHTML = buildTreeHTML(filtered);
    });

    // å±•é–‹/æ”¶åˆ
    function expandAllGroups(expand) {
        document.querySelectorAll('.branch-line').forEach(el => {
            el.style.display = expand ? 'block' : 'none';
        });
    }

    // è¡Œç‚ºè™•ç† (è¤‡è£½ä»£ç¢¼)
    function handleAction(code, zh) {
        const el = document.createElement('textarea');
        el.value = code;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);

        const toast = document.getElementById('toast');
        toast.innerText = `å·²è¤‡è£½ ${code}`;
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);
    }

    // æˆ‘çš„æœ€æ„›é‚è¼¯
    function toggleFav(code) {
        const idx = favorites.indexOf(code);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push(code);
        localStorage.setItem('icd_fav_tree_v2', JSON.stringify(favorites));

        // é‡æ–°æ¸²æŸ“ç•¶å‰ç•«é¢ä»¥æ›´æ–°æ˜Ÿæ˜Ÿç‹€æ…‹
        if (!document.getElementById('pageCategory').classList.contains('hidden')) renderCategoryTree(currentLetter);
        if (!document.getElementById('pageSearch').classList.contains('hidden')) {
            const val = document.getElementById('searchInput').value;
            if(val) document.getElementById('searchInput').dispatchEvent(new Event('input'));
        }
        renderFavorites();
    }

    function renderFavorites() {
        const container = document.getElementById('favList');
        const hint = document.getElementById('noFavHint');
        if (favorites.length === 0) {
            container.innerHTML = '';
            hint.style.display = 'block';
            return;
        }
        hint.style.display = 'none';

        container.innerHTML = favorites.map(code => {
            const item = icdData.find(i => i.code === code) || { zh: "æœªçŸ¥è¨ºæ–·" };
            return `
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center group cursor-pointer" onclick="handleAction('${code}', '${item.zh}')">
                    <div>
                        <div class="code-font font-bold text-sky-400">${code}</div>
                        <div class="text-sm text-slate-300">${item.zh}</div>
                    </div>
                    <button onclick="event.stopPropagation(); toggleFav('${code}')" class="text-slate-500 hover:text-red-500">âœ•</button>
                </div>
            `;
        }).join('');
    }

    init();
</script>
</body>
</html>

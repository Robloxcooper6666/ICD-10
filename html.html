<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 專業查詢系統</title>
    <style>
        :root { --primary: #0288d1; --fav: #ffca28; --bg: #f4f7f9; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background-color: var(--bg); color: #333; }
        
        /* 佈局容器 */
        .main-layout { display: flex; max-width: 1400px; margin: 20px auto; gap: 20px; padding: 0 20px; box-sizing: border-box; }
        
        /* 左側搜尋區 */
        .search-section { flex: 2; background: white; padding: 25px; border-radius: 12px; shadow: 0 4px 12px rgba(0,0,0,0.08); min-width: 0; }
        
        /* 右側收藏區 */
        .fav-section { flex: 1; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e0e6ed; height: fit-content; position: sticky; top: 20px; min-width: 300px; }
        
        h2, h3 { margin-top: 0; color: #2c3e50; }
        .stats-info { font-size: 0.85em; color: #666; margin-bottom: 15px; }
        
        input { width: 100%; padding: 12px; border: 2px solid #edf2f7; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        input:focus { outline: none; border-color: var(--primary); }

        .tag { display: inline-block; background: #e1f5fe; color: var(--primary); padding: 4px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; margin: 0 5px 5px 0; border: 1px solid #b3e5fc; }

        /* 表格優化 */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #f0f0f0; color: #888; }
        td { padding: 12px; border-bottom: 1px solid #f8f8f8; }
        .code-cell { font-family: monospace; font-weight: bold; color: #d81b60; }
        
        /* 星星按鈕 */
        .star { cursor: pointer; font-size: 18px; color: #ddd; transition: 0.2s; }
        .star.active { color: var(--fav); }
        
        /* 收藏列表項目 */
        .fav-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .fav-item:hover { background: #fffcf0; }
        .fav-item-info { flex: 1; }
        .fav-item-code { font-weight: bold; color: #d81b60; margin-right: 8px; }
        .remove-fav { color: #ccc; cursor: pointer; margin-left: 10px; }
        .remove-fav:hover { color: #ff5252; }

        @media (max-width: 900px) {
            .main-layout { flex-direction: column; }
            .fav-section { position: static; order: -1; }
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="search-section">
        <h2>ICD-10 搜尋</h2>
        <div class="stats-info">資料庫筆數：<span id="totalCount">...</span></div>
        
        <input type="text" id="searchInput" placeholder="輸入代碼或關鍵字...">
        
        <div id="hotTags" style="margin-bottom: 15px;"></div>

        <table>
            <thead>
                <tr>
                    <th width="40">★</th>
                    <th width="80">代碼</th>
                    <th>名稱</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
        <div id="noResult" style="display:none; text-align:center; padding:20px; color:#999;">無搜尋結果</div>
    </div>

    <div class="fav-section">
        <h3>⭐ 我的最愛</h3>
        <div id="favList">
            <div style="color:#ccc; font-size:13px;">尚未收藏任何代碼</div>
        </div>
    </div>
</div>

<script>
    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icdFav_v2') || '[]');
    let searchTimer;

    // 1. 載入資料
    fetch('icd10_codes_combined.json')
        .then(res => res.json())
        .then(data => {
            icdData = data;
            document.getElementById('totalCount').innerText = data.length.toLocaleString();
            renderFavorites();
            performSearch('');
        });

    // 2. 搜尋邏輯 (效能優化：僅顯示前 50 筆)
    function performSearch(q) {
        const query = q.toLowerCase().trim();
        const results = query === '' 
            ? icdData.slice(0, 15) 
            : icdData.filter(item => 
                item.code.toLowerCase().includes(query) || 
                item.en.toLowerCase().includes(query) || 
                item.zh.includes(query)
              ).slice(0, 50);

        renderTable(results);
    }

    // 3. 渲染主表格
    function renderTable(data) {
        const tbody = document.getElementById('resultBody');
        const noRes = document.getElementById('noResult');
        
        if (data.length === 0) {
            tbody.innerHTML = '';
            noRes.style.display = 'block';
            return;
        }
        
        noRes.style.display = 'none';
        tbody.innerHTML = data.map(item => {
            const isFav = favorites.some(f => f.code === item.code);
            return `
                <tr>
                    <td><span class="star ${isFav?'active':''}" onclick="toggleFav('${item.code}')">${isFav?'★':'☆'}</span></td>
                    <td class="code-cell">${item.code}</td>
                    <td>
                        <div style="font-weight:500">${item.zh}</div>
                        <div style="font-size:12px; color:#888">${item.en}</div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // 4. 收藏邏輯
    function toggleFav(code) {
        const index = favorites.findIndex(f => f.code === code);
        if (index > -1) {
            favorites.splice(index, 1);
        } else {
            const item = icdData.find(i => i.code === code);
            if (item) favorites.unshift(item); // 新收藏的放最上面
        }
        
        localStorage.setItem('icdFav_v2', JSON.stringify(favorites));
        renderFavorites();
        performSearch(document.getElementById('searchInput').value);
    }

    // 5. 渲染右側收藏欄
    function renderFavorites() {
        const container = document.getElementById('favList');
        if (favorites.length === 0) {
            container.innerHTML = '<div style="color:#ccc; font-size:13px;">尚未收藏任何代碼</div>';
            return;
        }

        container.innerHTML = favorites.map(item => `
            <div class="fav-item">
                <div class="fav-item-info">
                    <span class="fav-item-code">${item.code}</span>
                    <span>${item.zh}</span>
                </div>
                <span class="remove-fav" onclick="toggleFav('${item.code}')">✕</span>
            </div>
        `).join('');
    }

    // 6. 輸入防抖 (Debounce) 減少運算負擔
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            performSearch(e.target.value);
        }, 200); // 停止輸入 0.2 秒後才執行搜尋
    });
</script>

</body>
</html>

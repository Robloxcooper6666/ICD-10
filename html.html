<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 ä»£ç¢¼æŸ¥è©¢ç³»çµ±</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        h2 { margin-top: 0; color: #2c3e50; border-left: 5px solid #0288d1; padding-left: 15px; }
        
        /* çµ±è¨ˆè³‡è¨Šæ¨£å¼ */
        .stats-info { margin-bottom: 20px; font-size: 0.95em; color: #666; background: #f0f7ff; padding: 10px 15px; border-radius: 6px; border: 1px solid #d0e3f5; }
        .stats-info b { color: #0288d1; }

        input { width: 100%; padding: 14px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; border: 2px solid #eee; border-radius: 8px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #0288d1; }

        /* ç†±é–€æŸ¥è©¢æ¨£å¼ */
        .quick-search { margin-bottom: 25px; min-height: 35px; }
        .quick-search label { font-size: 14px; color: #777; margin-right: 10px; display: block; margin-bottom: 8px; }
        .tag {
            display: inline-block;
            background: #e1f5fe;
            color: #0288d1;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            border: 1px solid #b3e5fc;
            transition: all 0.2s;
        }
        .tag:hover { background: #0288d1; color: white; transform: translateY(-1px); }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 14px; text-align: left; }
        th { background-color: #fafafa; color: #666; font-weight: 600; text-transform: uppercase; font-size: 13px; }
        tr:hover { background-color: #fcfcfc; }
        .code-cell { font-family: "Courier New", monospace; font-weight: bold; color: #d81b60; }

        .no-result { color: #999; text-align: center; margin-top: 30px; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>ICD-10 ç–¾ç—…ä»£ç¢¼æŸ¥è©¢</h2>
    
    <div class="stats-info">
        ç›®å‰è³‡æ–™åº«å·²éŒ„å…¥ï¼š<span id="totalCount">è¼‰å…¥ä¸­...</span> ç­†ç–¾ç—…ä»£ç¢¼
    </div>

    <input type="text" id="searchInput" placeholder="æœå°‹ä»£ç¢¼ã€ä¸­æ–‡æˆ–è‹±æ–‡åç¨±... (æŒ‰ Enter ç´€éŒ„ç†±é–€æœå°‹)">

    <div class="quick-search" id="quickSearch">
        <label>ğŸ”¥ ç†±é–€æŸ¥è©¢ (æœå°‹è¶…é 5 æ¬¡)ï¼š</label>
        <span id="hotTags"></span>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 20%;">ä»£ç¢¼</th>
                <th style="width: 40%;">è‹±æ–‡åç¨±</th>
                <th style="width: 40%;">ä¸­æ–‡åç¨±</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>
    <div id="noResult" class="no-result" style="display: none;">æ‰¾ä¸åˆ°ç›¸ç¬¦çš„çµæœï¼Œè«‹è©¦è©¦å…¶ä»–é—œéµå­—ã€‚</div>
</div>

<script>
    let icdData = [];
    const THRESHOLD = 5; // è¨­å®šé–€æª»ç‚º 5 æ¬¡

    const searchInput = document.getElementById('searchInput');
    const hotTagsContainer = document.getElementById('hotTags');
    const totalCountSpan = document.getElementById('totalCount');
    const resultBody = document.getElementById('resultBody');
    const noResult = document.getElementById('noResult');

    // 1. åˆå§‹åŒ–è³‡æ–™
    fetch('icd10_codes_combined.json')
        .then(response => {
            if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥ JSON æª”æ¡ˆ');
            return response.json();
        })
        .then(data => {
            icdData = data;
            
            // æ›´æ–°ç¸½ç­†æ•¸é¡¯ç¤º (ä½¿ç”¨åƒåˆ†ä½)
            totalCountSpan.innerText = icdData.length.toLocaleString();
            
            // é è¨­é¡¯ç¤ºå‰ 10 ç­†
            displayResults(icdData.slice(0, 10));
            renderHotTags();
        })
        .catch(err => {
            console.error(err);
            totalCountSpan.innerText = "è®€å–å¤±æ•—";
        });

    // 2. æœå°‹æ ¸å¿ƒé‚è¼¯
    function performSearch(keyword) {
        const cleanKeyword = keyword.toLowerCase().trim();

        if (cleanKeyword === '') {
            displayResults(icdData.slice(0, 10));
            return;
        }

        const filtered = icdData.filter(item =>
            item.code.toLowerCase().includes(cleanKeyword) ||
            item.en.toLowerCase().includes(cleanKeyword) ||
            item.zh.includes(cleanKeyword)
        );
        
        displayResults(filtered);
    }

    // 3. ç´€éŒ„æœå°‹æ¬¡æ•¸åˆ° LocalStorage
    function recordSearch(keyword) {
        const val = keyword.trim();
        if (val.length < 2) return; 

        let history = JSON.parse(localStorage.getItem('icdSearchHistory') || '{}');
        history[val] = (history[val] || 0) + 1;
        localStorage.setItem('icdSearchHistory', JSON.stringify(history));

        renderHotTags(); 
    }

    // 4. æ¸²æŸ“ç†±é–€æ¨™ç±¤
    function renderHotTags() {
        const history = JSON.parse(localStorage.getItem('icdSearchHistory') || '{}');
        hotTagsContainer.innerHTML = '';

        const tags = Object.keys(history).filter(word => history[word] >= THRESHOLD);
        
        if (tags.length === 0) {
            hotTagsContainer.innerHTML = '<span style="color:#ccc; font-size:12px;">æš«ç„¡å¸¸ç”¨æ¨™ç±¤</span>';
            return;
        }

        tags.forEach(word => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.innerText = word;
            span.onclick = () => {
                searchInput.value = word;
                performSearch(word);
            };
            hotTagsContainer.appendChild(span);
        });
    }

    // 5. ç›£è½è¼¸å…¥èˆ‡ Enter
    searchInput.addEventListener('input', (e) => performSearch(e.target.value));

    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.target.value.trim() !== '') {
            recordSearch(e.target.value);
        }
    });

    // 6. æ¸²æŸ“çµæœè¡¨æ ¼
    function displayResults(data) {
        resultBody.innerHTML = '';

        if (data.length === 0) {
            noResult.style.display = 'block';
            return;
        }

        noResult.style.display = 'none';
        resultBody.innerHTML = data.map(item => `
            <tr>
                <td class="code-cell">${item.code}</td>
                <td>${item.en}</td>
                <td>${item.zh}</td>
            </tr>
        `).join('');
    }
</script>

</body>
</html>

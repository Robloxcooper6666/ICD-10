<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10æŸ¥è©¢ç³»çµ±V1.0</title>
    <style>
        :root {
            --bg-main: #f0f4f8;
            --panel-bg: rgba(255, 255, 255, 0.75);
            --accent-cyan: #00d2ff;
            --accent-blue: #0045ff;
            --text-dark: #1a202c;
            --tech-pink: #ff007a;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            background: var(--bg-main);
            color: var(--text-dark);
            background-image: radial-gradient(circle at 2px 2px, rgba(0,0,0,0.05) 1px, transparent 0);
            background-size: 30px 30px;
            overflow-x: hidden;
        }

        #bgCanvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.3;
        }

        .main-layout {
            display: flex;
            flex-direction: row; /* é è¨­æ©«å‘ */
            max-width: 1400px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 15px;
            box-sizing: border-box;
        }

        /* éŸ¿æ‡‰å¼æ ¸å¿ƒï¼šå°è¢å¹•åˆ‡æ›ç‚ºå‚ç›´æ’åˆ— */
        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
                margin: 10px auto;
            }
            .side-bar {
                order: -1; /* æ”¶è—èˆ‡åœ–è¡¨åœ¨æ‰‹æ©Ÿç«¯æ’åˆ°å‰é¢ï¼Œæˆ–æ ¹æ“šéœ€æ±‚èª¿æ•´ */
            }
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);
            position: relative;
            overflow: hidden;
        }

        .glass-panel::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
        }

        .search-section { flex: 2; padding: 25px; min-width: 0; }
        .side-bar { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0; }

        h2 {
            margin: 0 0 15px 0; font-size: clamp(1.2rem, 5vw, 1.75rem);
            background: linear-gradient(45deg, var(--accent-blue), var(--tech-pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .stats-tag {
            display: inline-block; padding: 4px 10px; background: #000; color: var(--accent-cyan);
            font-family: monospace; font-size: 11px; border-radius: 4px; margin-bottom: 15px;
        }

        input {
            width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px;
            background: rgba(255,255,255,0.6); font-size: 16px; box-sizing: border-box;
            transition: 0.3s;
        }
        input:focus { outline: none; border-color: var(--accent-cyan); background: #fff; }

        /* è¡¨æ ¼æ»¾å‹•å®¹å™¨ï¼šé˜²æ­¢å°è¢å¹•æ’é–‹ */
        .table-container { width: 100%; overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 500px; }
        th { text-align: left; padding: 10px; font-size: 12px; opacity: 0.7; }
        td { background: white; padding: 15px 10px; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        td:first-child { border-left: 1px solid #f0f0f0; border-radius: 10px 0 0 10px; }
        td:last-child { border-right: 1px solid #f0f0f0; border-radius: 0 10px 10px 0; }

        .code-pill {
            background: #f0f7ff; color: var(--accent-blue); padding: 4px 8px;
            border-radius: 5px; font-family: monospace; font-weight: 800; font-size: 0.9em;
        }

        .chart-box { padding: 20px; text-align: center; }
        #dataChart { width: 100%; max-height: 250px; }

        .fav-item {
            background: white; margin-bottom: 8px; padding: 12px; border-radius: 10px;
            border-left: 4px solid var(--tech-pink); display: flex; justify-content: space-between;
            align-items: center; font-size: 14px;
        }

        @media (max-width: 480px) {
            .search-section { padding: 15px; }
            td { padding: 12px 8px; }
        }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="main-layout">
    <div class="glass-panel search-section">
        <div class="stats-tag">ç‹€æ…‹ï¼šé‹ä½œä¸­ // è¼‰å…¥ï¼š<span id="count">0</span></div>
        <h2>ICD-10</h2>

        <input type="text" id="searchInput" placeholder="æœå°‹ä»£ç¢¼æˆ–ç–¾ç—…åç¨±...">

        <div class="table-container">
            <table>
                <thead>
                    <tr><th width="50">æ”¶è—</th><th width="100">ä»£è™Ÿ</th><th>è¨ºæ–·åç¨±</th></tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>

    <div class="side-bar">
        <div class="glass-panel chart-box">
            <h3 style="font-size: 14px; color: var(--accent-blue); margin: 0 0 15px 0; text-align: left;">ğŸ“Š æ¯”ä¾‹åˆ†ä½ˆåˆ†æ</h3>
            <canvas id="dataChart"></canvas>
        </div>

        <div class="glass-panel chart-box">
            <h3 style="font-size: 14px; color: var(--tech-pink); margin: 0 0 15px 0; text-align: left;">â­ å¿«é€Ÿé‡˜é¸</h3>
            <div id="favList"></div>
        </div>
    </div>
</div>

<script>
    const bgCanvas = document.getElementById('bgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const dataCanvas = document.getElementById('dataChart');
    const dataCtx = dataCanvas.getContext('2d');

    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icdFav_v5') || '[]');
    let currentResults = [];

    // èƒŒæ™¯å‹•æ…‹
    function initBg() {
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;
        const particles = Array.from({length: 30}, () => ({
            x: Math.random() * bgCanvas.width,
            y: Math.random() * bgCanvas.height,
            s: Math.random() * 1.5 + 0.5
        }));

        function animate() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            bgCtx.fillStyle = 'rgba(0, 210, 255, 0.2)';
            particles.forEach(p => {
                p.y -= p.s;
                if (p.y < 0) p.y = bgCanvas.height;
                bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.s, 0, Math.PI*2); bgCtx.fill();
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    // Canvas éŸ¿æ‡‰å¼ç¹ªåœ–
    function drawTechChart(data) {
        const container = dataCanvas.parentElement;
        // æ ¹æ“šå®¹å™¨å¯¬åº¦å‹•æ…‹èª¿æ•´ Canvas è§£æåº¦
        dataCanvas.width = container.clientWidth * 2;
        dataCanvas.height = 200 * 2;
        dataCtx.scale(2, 2);

        const stats = {};
        data.slice(0, 30).forEach(item => { stats[item.code[0]] = (stats[item.code[0]] || 0) + 1; });
        const keys = Object.keys(stats);
        const maxVal = Math.max(...Object.values(stats)) || 1;

        dataCtx.clearRect(0, 0, dataCanvas.width, dataCanvas.height);
        keys.forEach((key, i) => {
            const h = (stats[key] / maxVal) * 120;
            const barW = Math.min(25, (container.clientWidth / keys.length) - 10);
            const x = 30 + (i * (barW + 15));

            let grad = dataCtx.createLinearGradient(0, 160, 0, 160-h);
            grad.addColorStop(0, 'rgba(0, 210, 255, 0.8)');
            grad.addColorStop(1, 'var(--accent-blue)');

            dataCtx.fillStyle = grad;
            dataCtx.roundRect ? dataCtx.fillRoundedRect(x, 160-h, barW, h, 4) : dataCtx.fillRect(x, 160-h, barW, h);

            dataCtx.fillStyle = '#666';
            dataCtx.font = '10px monospace';
            dataCtx.fillText(key, x + (barW/4), 175);
        });
    }

    // è¼”åŠ©å‡½å¼ï¼šåœ“è§’çŸ©å½¢ (éƒ¨åˆ†ç€è¦½å™¨æ”¯æ´)
    CanvasRenderingContext2D.prototype.fillRoundedRect = function(x, y, w, h, r) {
        this.beginPath();
        this.moveTo(x + r, y);
        this.arcTo(x + w, y, x + w, y + h, r);
        this.arcTo(x + w, y + h, x, y + h, r);
        this.arcTo(x, y + h, x, y, r);
        this.arcTo(x, y, x + w, y, r);
        this.closePath();
        this.fill();
    };

    function performSearch(q) {
        const query = q.toLowerCase();
        currentResults = icdData.filter(item =>
            item.code.toLowerCase().includes(query) || item.zh.includes(query) || item.en.toLowerCase().includes(query)
        ).slice(0, 15);

        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = currentResults.map(item => {
            const isFav = favorites.some(f => f.code === item.code);
            return `
                <tr>
                    <td onclick="toggleFav('${item.code}')" style="cursor:pointer; font-size:18px; color:${isFav?'var(--tech-pink)':'#ccc'}">âœ¦</td>
                    <td><span class="code-pill">${item.code}</span></td>
                    <td>
                        <div style="font-weight:700; font-size:14px;">${item.zh}</div>
                        <div style="font-size:11px; color:#777; font-family:monospace;">${item.en}</div>
                    </td>
                </tr>
            `;
        }).join('');
        drawTechChart(currentResults);
        renderFavs();
    }

    function toggleFav(code) {
        const idx = favorites.findIndex(f => f.code === code);
        if(idx > -1) favorites.splice(idx, 1);
        else favorites.unshift(icdData.find(i => i.code === code));
        localStorage.setItem('icdFav_v5', JSON.stringify(favorites));
        performSearch(document.getElementById('searchInput').value);
    }

    function renderFavs() {
        const list = document.getElementById('favList');
        if (favorites.length === 0) { list.innerHTML = '<div style="font-size:12px; opacity:0.5;">ç„¡é …ç›®</div>'; return; }
        list.innerHTML = favorites.map(f => `
            <div class="fav-item">
                <span><b>${f.code}</b> ${f.zh.slice(0,10)}</span>
                <span onclick="toggleFav('${f.code}')" style="cursor:pointer">Ã—</span>
            </div>
        `).join('');
    }

    // è¦–çª—èª¿æ•´å¤§å°è™•ç†
    window.addEventListener('resize', () => {
        initBg();
        drawTechChart(currentResults);
    });

    fetch('icd10_codes_combined.json')
        .then(res => res.json())
        .then(data => {
            icdData = data;
            document.getElementById('count').innerText = data.length.toLocaleString();
            initBg(); performSearch('');
        })
        .catch(() => {
            icdData = [{code:"DEMO", zh:"æ¸¬è©¦æ•¸æ“š", en:"Demo Data"}];
            initBg(); performSearch('');
        });

    document.getElementById('searchInput').addEventListener('input', (e) => performSearch(e.target.value));
</script>
</body>
</html>

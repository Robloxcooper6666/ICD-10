<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 查詢系統</title>
    <style>
        :root {
            --bg-deep: #0f172a;
            --card-bg: #1e293b;
            --accent: #0ea5e9;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --highlight: #f472b6;
            --fav-star: #fbbf24;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: 'Inter', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            line-height: 1.5;
        }

        .main-layout {
            display: flex;
            max-width: 1400px;
            margin: 30px auto;
            gap: 25px;
            padding: 0 20px;
        }

        .search-section {
            flex: 2;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }

        .fav-section {
            flex: 1;
            background: #111827;
            padding: 25px;
            border-radius: 16px;
            border: 2px solid var(--accent);
            height: fit-content;
            position: sticky;
            top: 20px;
            min-width: 320px;
        }

        /* 更新日誌區塊 */
        .update-log {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            border-left: 3px solid var(--highlight);
        }
        .update-item { color: var(--text-muted); margin-bottom: 4px; }
        .update-date { color: var(--highlight); font-weight: bold; margin-right: 8px; }

        h2 { color: var(--accent); margin-top: 0; font-size: 24px; letter-spacing: 1px; }
        h3 { color: var(--fav-star); margin-top: 0; display: flex; align-items: center; gap: 8px; }

        .stats-info {
            background: rgba(14, 165, 233, 0.1);
            color: var(--accent);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
            display: flex;
            justify-content: space-between;
        }

        input {
            width: 100%;
            padding: 15px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 10px;
            font-size: 18px;
            color: white;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid #334155;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 12px;
        }
        td { padding: 18px 15px; border-bottom: 1px solid #334155; }
        tr:hover { background: rgba(255,255,255,0.03); }

        .code-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            color: var(--highlight);
        }

        .zh-name { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .en-name { font-size: 13px; color: var(--text-muted); font-style: italic; }

        .star {
            cursor: pointer;
            font-size: 24px;
            color: #334155;
            transition: 0.2s;
        }
        .star.active { color: var(--fav-star); }
        .star:hover { transform: scale(1.2); }

        .fav-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--fav-star);
        }
        .fav-item-code { font-weight: bold; color: var(--highlight); margin-right: 8px; }
        .remove-fav { color: #475569; cursor: pointer; padding: 5px; }
        .remove-fav:hover { color: var(--danger); }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .2em 0 0 rgba(0,0,0,0), .4em 0 0 rgba(0,0,0,0); } 40% { color: var(--accent); text-shadow: .2em 0 0 rgba(0,0,0,0), .4em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .2em 0 0 var(--accent), .4em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .2em 0 0 var(--accent), .4em 0 0 var(--accent); } }

        @media (max-width: 1000px) {
            .main-layout { flex-direction: column; }
            .fav-section { position: static; order: -1; }
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="search-section">
        <h2>ICD-10 診斷查詢系統</h2>

        <div class="update-log">
            <div class="update-item">
                <span class="update-date">2026/2/4 10:47</span>
                搜尋功能優化：獲取資料庫方式改為直接獲取，不經過 https://raw.githubusercontent.com/Robloxcooper6666<br>/ICD-10/main/icd10_codes_combined.json
            </div>
        </div>

        <div class="stats-info" id="statusBox">
            <span id="statusMessage" class="loading-dots">正在讀取資料庫檔案</span>
            <span id="dataCount"></span>
        </div>

        <input type="text" id="searchInput" placeholder="搜尋代碼、中文或英文關鍵字 (多組用空格隔開)..." autofocus>

        <table>
            <thead>
                <tr>
                    <th width="50">釘選</th>
                    <th width="120">代碼</th>
                    <th>診斷名稱 (中/英)</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
        <div id="noResult" style="display:none; text-align:center; padding:40px; color:var(--text-muted);">
            找不到相符的診斷代碼
        </div>
    </div>

    <div class="fav-section">
        <h3>⭐ 我的收藏庫</h3>
        <div id="favList"></div>
    </div>
</div>

<script>
    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icd_fav_v4') || '[]');
    let searchTimer;

    async function init() {
        const msg = document.getElementById('statusMessage');
        const count = document.getElementById('dataCount');

        try {
            // 改為相對路徑讀取，不使用 external github 連結
            const response = await fetch('./icd10_codes_combined.json');
            if (!response.ok) throw new Error('無法讀取 JSON 檔案，請確認檔案是否存在於同目錄');

            icdData = await response.json();

            msg.innerText = "✅ 直接獲取模式：資料庫連線正常";
            msg.style.color = "var(--success)";
            count.innerText = `共 ${icdData.length.toLocaleString()} 筆`;
        } catch (err) {
            msg.innerHTML = "❌ 讀取失敗：請確認 JSON 檔案路徑或透過伺服器環境開啟";
            msg.style.color = "var(--danger)";
            console.error(err);
        }

        renderFavorites();
        performSearch('');
    }

    function performSearch(query) {
        const keywords = query.toLowerCase().trim().split(/\s+/).filter(k => k !== "");
        let results = [];

        if (keywords.length === 0) {
            results = icdData.slice(0, 20);
        } else {
            results = icdData.filter(item => {
                const code = (item.code || "").toLowerCase();
                const zh = (item.zh || "").toLowerCase();
                const en = (item.en || "").toLowerCase();

                return keywords.every(kw =>
                    code.includes(kw) || zh.includes(kw) || en.includes(kw)
                );
            });

            results.sort((a, b) => {
                const firstKw = keywords[0];
                if (a.code.toLowerCase() === firstKw) return -1;
                if (b.code.toLowerCase() === firstKw) return 1;
                if (a.code.toLowerCase().startsWith(firstKw)) return -1;
                return 0;
            });

            results = results.slice(0, 100);
        }

        renderTable(results);
    }

    function renderTable(data) {
        const tbody = document.getElementById('resultBody');
        const noRes = document.getElementById('noResult');

        if (data.length === 0) {
            tbody.innerHTML = '';
            noRes.style.display = 'block';
            return;
        }

        noRes.style.display = 'none';
        const fragment = document.createDocumentFragment();

        data.forEach(item => {
            const isFav = favorites.some(f => f.code === item.code);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="star ${isFav ? 'active' : ''}" data-code="${item.code}">★</span></td>
                <td class="code-cell">${item.code}</td>
                <td>
                    <div class="zh-name">${item.zh || '---'}</div>
                    <div class="en-name">${item.en || '---'}</div>
                </td>
            `;

            tr.querySelector('.star').addEventListener('click', (e) => {
                toggleFav(item.code);
            });

            fragment.appendChild(tr);
        });

        tbody.innerHTML = '';
        tbody.appendChild(fragment);
    }

    function toggleFav(code) {
        const index = favorites.findIndex(f => f.code === code);
        if (index > -1) {
            favorites.splice(index, 1);
        } else {
            const item = icdData.find(i => i.code === code);
            if (item) favorites.unshift(item);
        }

        localStorage.setItem('icd_fav_v4', JSON.stringify(favorites));
        renderFavorites();

        document.querySelectorAll(`.star[data-code="${code}"]`).forEach(s => {
            s.classList.toggle('active');
        });
    }

    function renderFavorites() {
        const container = document.getElementById('favList');
        if (favorites.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted); font-size:14px; text-align:center; padding:20px;">尚無釘選項目</div>';
            return;
        }

        container.innerHTML = favorites.map(item => `
            <div class="fav-item">
                <div style="flex:1">
                    <span class="fav-item-code">${item.code}</span>
                    <div style="font-size:13px; color:var(--text-main); margin-top:2px;">${item.zh}</div>
                </div>
                <span class="remove-fav" onclick="toggleFav('${item.code}')">✕</span>
            </div>
        `).join('');
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => performSearch(e.target.value), 250);
    });

    init();
</script>
</body>
</html>

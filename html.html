<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 Neural Interface</title>
    <style>
        :root {
            --bg-main: #f0f4f8;
            --panel-bg: rgba(255, 255, 255, 0.7);
            --accent-cyan: #00d2ff;
            --accent-blue: #0045ff;
            --text-dark: #1a202c;
            --tech-pink: #ff007a;
            --border-glow: rgba(0, 210, 255, 0.3);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: var(--bg-main);
            color: var(--text-dark);
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 2px 2px, rgba(0,0,0,0.05) 1px, transparent 0);
            background-size: 40px 40px;
        }

        /* 背景動態 Canvas */
        #bgCanvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.4;
        }

        .main-layout {
            display: flex; max-width: 1400px; margin: 40px auto; gap: 30px; padding: 0 25px;
            position: relative;
        }

        /* 玻璃擬態面板 */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            position: relative;
            overflow: hidden;
        }

        .glass-panel::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
        }

        .search-section { flex: 2; padding: 40px; }
        .side-bar { flex: 1; display: flex; flex-direction: column; gap: 25px; min-width: 350px; }

        /* 標題與裝飾 */
        h2 {
            margin-top: 0; letter-spacing: 2px; text-transform: uppercase;
            font-size: 28px; background: linear-gradient(45deg, var(--accent-blue), var(--tech-pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .stats-tag {
            display: inline-block; padding: 4px 12px; background: #000; color: var(--accent-cyan);
            font-family: monospace; font-size: 12px; border-radius: 4px; margin-bottom: 20px;
        }

        /* 輸入框科技感 */
        .input-group { position: relative; margin-bottom: 30px; }
        input {
            width: 100%; padding: 18px 25px; border: 2px solid #e2e8f0; border-radius: 12px;
            background: rgba(255,255,255,0.5); font-size: 18px; color: var(--text-dark);
            transition: all 0.3s; box-sizing: border-box;
        }
        input:focus {
            outline: none; border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
        }

        /* 表格優化 */
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { text-align: left; padding: 10px 20px; color: var(--text-dark); font-weight: 800; font-size: 12px; text-transform: uppercase; }
        td { background: white; padding: 20px; transition: transform 0.2s; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        td:first-child { border-left: 1px solid #f0f0f0; border-radius: 12px 0 0 12px; }
        td:last-child { border-right: 1px solid #f0f0f0; border-radius: 0 12px 12px 0; }
        tr:hover td { transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; }

        .code-pill {
            background: #f0f7ff; color: var(--accent-blue); padding: 5px 10px;
            border-radius: 6px; font-family: 'Courier New', Courier, monospace; font-weight: 900;
        }

        /* Canvas 數據可視化區 */
        .chart-box { padding: 20px; }
        #dataChart { width: 100%; height: 250px; filter: drop-shadow(0 0 10px rgba(0, 210, 255, 0.3)); }

        .fav-item {
            background: white; margin-bottom: 10px; padding: 15px; border-radius: 10px;
            border-left: 5px solid var(--tech-pink); display: flex; justify-content: space-between;
        }

        /* 滾動條科技感 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--accent-cyan); border-radius: 10px; }

    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="main-layout">
    <div class="glass-panel search-section">
        <div class="stats-tag">STATUS: OPERATIONAL // DATA_LOADED: <span id="count">0</span></div>
        <h2>Diagnostic Nexus</h2>

        <div class="input-group">
            <input type="text" id="searchInput" placeholder="Initialize Search Sequence...">
        </div>

        <table>
            <thead>
                <tr><th width="80">Fav</th><th width="120">ID_CODE</th><th>NOMENCLATURE</th></tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>

    <div class="side-bar">
        <div class="glass-panel chart-box">
            <h3 style="font-size: 14px; color: var(--accent-blue);">比例</h3>
            <canvas id="dataChart"></canvas>
        </div>

        <div class="glass-panel chart-box" style="flex-grow: 1;">
            <h3 style="font-size: 14px; color: var(--tech-pink);">喜愛項目</h3>
            <div id="favList"></div>
        </div>
    </div>
</div>

<script>
    const bgCanvas = document.getElementById('bgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const dataCanvas = document.getElementById('dataChart');
    const dataCtx = dataCanvas.getContext('2d');

    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icdFav_v4') || '[]');

    // 1. 背景科技感動畫 (網格粒子)
    function initBg() {
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;
        const particles = [];
        for(let i=0; i<50; i++) particles.push({x: Math.random()*bgCanvas.width, y: Math.random()*bgCanvas.height, s: Math.random()*2});

        function animate() {
            bgCtx.clearRect(0,0,bgCanvas.width, bgCanvas.height);
            bgCtx.fillStyle = 'rgba(0, 210, 255, 0.3)';
            particles.forEach(p => {
                p.y -= p.s;
                if(p.y < 0) p.y = bgCanvas.height;
                bgCtx.beginPath();
                bgCtx.arc(p.x, p.y, p.s, 0, Math.PI*2);
                bgCtx.fill();
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    // 2. 數據處理與繪圖
    function drawTechChart(data) {
        dataCanvas.width = dataCanvas.offsetWidth * 2;
        dataCanvas.height = dataCanvas.offsetHeight * 2;
        dataCtx.scale(2, 2);

        const stats = {};
        data.slice(0, 30).forEach(item => {
            const char = item.code[0];
            stats[char] = (stats[char] || 0) + 1;
        });

        const keys = Object.keys(stats);
        const maxVal = Math.max(...Object.values(stats));

        dataCtx.clearRect(0,0, 400, 400);
        keys.forEach((key, i) => {
            const h = (stats[key] / maxVal) * 150;
            const x = 40 + (i * 45);

            // 科技感長條
            let grad = dataCtx.createLinearGradient(0, 200, 0, 200-h);
            grad.addColorStop(0, 'rgba(0, 210, 255, 0.8)');
            grad.addColorStop(1, 'rgba(0, 69, 255, 1)');

            dataCtx.fillStyle = grad;
            dataCtx.fillRect(x, 200 - h, 25, h);

            // 底部文字
            dataCtx.fillStyle = '#1a202c';
            dataCtx.font = 'bold 10px monospace';
            dataCtx.fillText(key, x + 8, 215);
        });
    }

    // 3. 核心功能
    fetch('icd10_codes_combined.json')
        .then(res => res.json())
        .then(data => {
            icdData = data;
            document.getElementById('count').innerText = data.length;
            performSearch('');
        })
        .catch(() => {
            // Mock data if file missing
            icdData = [{code:"A01.0", zh:"傷寒", en:"Typhoid fever"}, {code:"E11.9", zh:"糖尿病", en:"Diabetes"}, {code:"I10", zh:"高血壓", en:"HTN"}];
            performSearch('');
        });

    function performSearch(q) {
        const query = q.toLowerCase();
        const results = icdData.filter(item =>
            item.code.toLowerCase().includes(query) ||
            item.zh.includes(query) ||
            item.en.toLowerCase().includes(query)
        ).slice(0, 15);

        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = results.map(item => {
            const isFav = favorites.some(f => f.code === item.code);
            return `
                <tr>
                    <td><span style="color:${isFav?'var(--tech-pink)':'#ccc'}" onclick="toggleFav('${item.code}')">✦</span></td>
                    <td><span class="code-pill">${item.code}</span></td>
                    <td>
                        <div style="font-weight:800; color:var(--text-dark)">${item.zh}</div>
                        <div style="font-size:11px; color:var(--text-muted); font-family:monospace;">${item.en}</div>
                    </td>
                </tr>
            `;
        }).join('');
        drawTechChart(results);
        renderFavs();
    }

    function toggleFav(code) {
        const idx = favorites.findIndex(f => f.code === code);
        if(idx > -1) favorites.splice(idx, 1);
        else favorites.unshift(icdData.find(i => i.code === code));
        localStorage.setItem('icdFav_v4', JSON.stringify(favorites));
        performSearch(document.getElementById('searchInput').value);
    }

    function renderFavs() {
        const list = document.getElementById('favList');
        list.innerHTML = favorites.map(f => `
            <div class="fav-item">
                <span style="font-size:13px;"><b>${f.code}</b> ${f.zh}</span>
                <span onclick="toggleFav('${f.code}')" style="cursor:pointer">×</span>
            </div>
        `).join('');
    }

    document.getElementById('searchInput').addEventListener('input', (e) => performSearch(e.target.value));
    window.addEventListener('resize', initBg);
    initBg();

</script>
</body>
</html>

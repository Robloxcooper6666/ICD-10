<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 æ™ºæ…§åˆ†å±¤æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-deep: #0f172a;
            --card-bg: #1e293b;
            --accent: #0ea5e9;
            --text-main: #f8fafc;
            --highlight: #f472b6;
            --fav-star: #fbbf24;
        }
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', 'PingFang TC', sans-serif;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .code-font { font-family: 'JetBrains Mono', monospace; }
        .expand-transition { transition: max-height 0.3s ease-out, opacity 0.2s; }
        .item-row:hover { background: rgba(255,255,255,0.03); }
        .active-star { color: var(--fav-star) !important; text-shadow: 0 0 8px rgba(251, 191, 36, 0.4); }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
    
    <!-- å·¦å´ï¼šæœå°‹èˆ‡çµæœ -->
    <div class="flex-1 bg-[#1e293b] rounded-2xl p-6 shadow-2xl border border-slate-700">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-sky-400 tracking-tight">ICD-10 æ™ºæ…§æª¢ç´¢</h2>
            <div id="statusTag" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 border border-slate-700">é€£ç·šä¸­...</div>
        </div>

        <div class="relative mb-6">
            <input type="text" id="searchInput" 
                class="w-full bg-slate-900 border-2 border-slate-700 rounded-xl px-5 py-4 text-lg focus:outline-none focus:border-sky-500 transition-all placeholder:text-slate-500"
                placeholder="è¼¸å…¥ä»£ç¢¼ã€ä¸­è‹±æ–‡é—œéµå­—... (å¤šé—œéµå­—è«‹ç”¨ç©ºæ ¼)">
            <div class="absolute right-4 top-4 text-slate-500 pointer-events-none">
                <kbd class="bg-slate-800 px-2 py-1 rounded border border-slate-600 text-xs">Enter</kbd>
            </div>
        </div>

        <!-- çµæœè¡¨æ ¼ -->
        <div class="overflow-hidden rounded-xl border border-slate-700 bg-slate-900/50">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider">
                    <tr>
                        <th class="px-4 py-3 w-12 text-center">â­</th>
                        <th class="px-4 py-3 w-32">ä»£ç¢¼ (ç†±åº¦)</th>
                        <th class="px-4 py-3">è¨ºæ–·åç¨±</th>
                    </tr>
                </thead>
                <tbody id="resultBody" class="divide-y divide-slate-800">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
            <div id="loading" class="py-20 text-center text-slate-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-sky-500 border-t-transparent mb-4"></div>
                <p>æ­£åœ¨å¾ GitHub è¼‰å…¥è³‡æ–™åº«...</p>
            </div>
        </div>
    </div>

    <!-- å³å´ï¼šæ™ºæ…§æ”¶è—åº« (åˆ†é¡é¡¯ç¤º) -->
    <div class="w-full lg:w-96 flex flex-col gap-6">
        <div class="bg-slate-900 border-2 border-sky-500/50 rounded-2xl p-5 shadow-xl sticky top-8">
            <div class="flex items-center gap-2 mb-4">
                <span class="text-xl">â­</span>
                <h3 class="text-lg font-bold text-amber-400">æ™ºæ…§æ”¶è—åº« (åˆ†é¡)</h3>
            </div>
            
            <div id="favContainer" class="custom-scroll overflow-y-auto max-h-[70vh] space-y-3">
                <!-- è‡ªå‹•åˆ†é¡å¾Œçš„æ”¶è—é … -->
            </div>
            
            <div id="noFavHint" class="text-center py-10 text-slate-500 text-sm">
                ç›®å‰æ²’æœ‰æ”¶è—é …ç›®<br>é»æ“Šæ˜Ÿæ˜Ÿé€²è¡Œæ¨™è¨˜
            </div>
        </div>
    </div>
</div>

<!-- è¤‡è£½æç¤º -->
<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 font-bold">
    å·²è¤‡è£½ä»£ç¢¼ï¼
</div>

<script>
    const DATA_URL = 'https://raw.githubusercontent.com/Robloxcooper6666/ICD-10/main/icd10_codes_combined.json';
    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icd_fav_v5') || '[]');
    let clickCounts = JSON.parse(localStorage.getItem('icd_clicks_v5') || '{}');

    // åˆå§‹åŒ–
    async function init() {
        try {
            const res = await fetch(DATA_URL);
            icdData = await res.json();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('statusTag').innerText = `å·²é€£ç·š: ${icdData.length.toLocaleString()} ç­†`;
            document.getElementById('statusTag').classList.add('text-green-400');
            
            renderTable('');
            renderFavorites();
        } catch (err) {
            document.getElementById('loading').innerText = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ã€‚';
        }
    }

    // æœå°‹èˆ‡åˆ†å±¤è™•ç†
    function renderTable(query) {
        const tbody = document.getElementById('resultBody');
        const keywords = query.toLowerCase().trim().split(/\s+/).filter(k => k);
        
        let filtered = icdData;
        if (keywords.length > 0) {
            filtered = icdData.filter(item => {
                const searchStr = `${item.code} ${item.zh} ${item.en}`.toLowerCase();
                return keywords.every(kw => searchStr.includes(kw));
            });
        }

        // æ’åºï¼šç†±åº¦å„ªå…ˆ
        filtered.sort((a, b) => (clickCounts[b.code] || 0) - (clickCounts[a.code] || 0));

        // é™åˆ¶é¡¯ç¤ºå‰ 100 ç­†ï¼Œé¿å…çœ¼èŠ±
        const displayData = filtered.slice(0, 100);
        
        tbody.innerHTML = displayData.map(item => {
            const isFav = favorites.includes(item.code);
            const count = clickCounts[item.code] || 0;
            return `
                <tr class="item-row group cursor-pointer border-b border-slate-800" onclick="handleAction('${item.code}', '${item.zh}')">
                    <td class="p-4 text-center">
                        <button onclick="event.stopPropagation(); toggleFav('${item.code}')" 
                                class="text-slate-600 hover:text-amber-400 transition-colors ${isFav ? 'active-star' : ''}">
                            â˜…
                        </button>
                    </td>
                    <td class="p-4">
                        <span class="code-font font-bold text-pink-400">${item.code}</span>
                        ${count > 0 ? `<span class="ml-2 text-[10px] bg-orange-500/20 text-orange-400 px-1.5 py-0.5 rounded">ğŸ”¥ ${count}</span>` : ''}
                    </td>
                    <td class="p-4">
                        <div class="text-slate-100 font-medium">${item.zh || '---'}</div>
                        <div class="text-slate-500 text-xs mt-1 truncate max-w-md">${item.en || '---'}</div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // è™•ç†é»æ“Šã€è¤‡è£½ã€ç†±åº¦
    function handleAction(code, zh) {
        clickCounts[code] = (clickCounts[code] || 0) + 1;
        localStorage.setItem('icd_clicks_v5', JSON.stringify(clickCounts));
        
        // è¤‡è£½
        const el = document.createElement('textarea');
        el.value = code;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);

        // Toast
        const toast = document.getElementById('toast');
        toast.innerText = `å·²è¤‡è£½ ${code} (${zh})`;
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);

        // åˆ·æ–°åˆ—è¡¨ï¼ˆæ›´æ–°ç«è‹—ï¼‰
        renderTable(document.getElementById('searchInput').value);
    }

    // æ”¶è—åŠŸèƒ½
    function toggleFav(code) {
        const idx = favorites.indexOf(code);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push(code);
        
        localStorage.setItem('icd_fav_v5', JSON.stringify(favorites));
        renderTable(document.getElementById('searchInput').value);
        renderFavorites();
    }

    // æ™ºæ…§åˆ†é¡æ¸²æŸ“æ”¶è—åº«
    function renderFavorites() {
        const container = document.getElementById('favContainer');
        const hint = document.getElementById('noFavHint');
        
        if (favorites.length === 0) {
            container.innerHTML = '';
            hint.style.display = 'block';
            return;
        }
        hint.style.display = 'none';

        // é€²è¡Œåˆ†å±¤æ­¸é¡
        const grouped = {};
        favorites.forEach(code => {
            const mainGroup = code.split('.')[0]; // å–å¾—å°æ•¸é»å‰çš„ä»£ç¢¼
            if (!grouped[mainGroup]) grouped[mainGroup] = [];
            grouped[mainGroup].push(code);
        });

        const sortedGroups = Object.keys(grouped).sort();

        container.innerHTML = sortedGroups.map(group => {
            const subItems = grouped[group];
            const groupInfo = icdData.find(i => i.code === group) || { zh: "ä¸»åˆ†é¡" };
            
            return `
                <div class="bg-slate-800/50 rounded-lg overflow-hidden border border-slate-700">
                    <div class="bg-slate-800 px-3 py-2 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-pink-400 font-bold code-font">${group}</span>
                            <span class="text-xs text-slate-400">${groupInfo.zh}</span>
                        </div>
                        <span class="text-[10px] bg-slate-700 text-slate-400 px-2 py-0.5 rounded-full">${subItems.length}</span>
                    </div>
                    <div class="p-2 space-y-1">
                        ${subItems.map(code => {
                            const item = icdData.find(i => i.code === code);
                            return `
                                <div class="flex justify-between items-center p-2 hover:bg-slate-700/50 rounded group transition-all" 
                                     onclick="handleAction('${code}', '${item?.zh || ''}')">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-bold text-sky-400 code-font">${code}</span>
                                        <span class="text-[11px] text-slate-400 truncate w-48">${item?.zh || ''}</span>
                                    </div>
                                    <button onclick="event.stopPropagation(); toggleFav('${code}')" class="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-400 p-1">âœ•</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    // è¼¸å…¥ç›£è½
    let debounceTimer;
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            renderTable(e.target.value);
        }, 300);
    });

    init();
</script>
</body>
</html>

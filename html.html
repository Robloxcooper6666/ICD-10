<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD-10 æ™ºæ…§åˆ†å±¤æ¨¹ç‹€ç³»çµ±V2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-deep: #0f172a;
            --card-bg: #1e293b;
            --accent: #0ea5e9;
            --text-main: #f8fafc;
            --highlight: #f472b6;
            --fav-star: #fbbf24;
        }
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            overflow-x: hidden;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .code-font { font-family: 'JetBrains Mono', 'Consolas', monospace; }

        .tab-active {
            background: var(--accent);
            color: white !important;
            border-radius: 0.5rem;
        }

        /* æ¨¹ç‹€åˆ†æ”¯é€£æ¥ç·š */
        .branch-line {
            position: relative;
        }
        .branch-line::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0;
            bottom: 1.5rem;
            width: 2px;
            background: #334155;
        }
        .branch-item::after {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1.2rem;
            width: 1rem;
            height: 2px;
            background: #334155;
        }

        .active-star { color: var(--fav-star) !important; text-shadow: 0 0 8px rgba(251, 191, 36, 0.4); }

        /* å­—æ¯å°èˆª */
        .letter-btn {
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .letter-btn:hover, .letter-btn.active {
            background: var(--accent);
            color: white;
        }

        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .highlight-text {
            color: var(--highlight);
            font-weight: bold;
        }
    </style>
</head>
<body class="p-0 flex flex-col h-screen">

<!-- é ‚éƒ¨å°è¦½åˆ— -->
<nav class="bg-slate-900 border-b border-slate-800 shrink-0 z-50 shadow-xl">
    <div class="max-w-7xl mx-auto px-6 py-3">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold text-sky-400 flex items-center gap-2">
                <span class="bg-sky-500/20 p-1 rounded">ICD-10</span>
                <span>æ™ºæ…§æª¢ç´¢ç³»çµ± V2.2</span>
            </h1>
            <div class="flex bg-slate-800 rounded-lg p-1 gap-1">
                <button onclick="switchTab('search')" id="tabSearch" class="px-4 py-1.5 text-sm font-medium tab-active">ğŸ” æœå°‹</button>
                <button onclick="switchTab('category')" id="tabCategory" class="px-4 py-1.5 text-sm font-medium text-slate-400 hover:text-white">ğŸ—‚ï¸ é¡åˆ¥ç€è¦½</button>
                <button onclick="switchTab('favorites')" id="tabFavs" class="px-4 py-1.5 text-sm font-medium text-slate-400 hover:text-white">â­ æˆ‘çš„æœ€æ„›</button>
            </div>
        </div>
        <!-- å­—æ¯ç´¢å¼•åˆ— -->
        <div id="letterNav" class="flex flex-wrap gap-1 border-t border-slate-800 pt-3 hidden">
            <!-- A-Z å­—æ¯ç”± JS ç”Ÿæˆ -->
        </div>
    </div>
</nav>

<div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
    <div class="max-w-6xl mx-auto">

        <!-- é ç±¤ä¸€ï¼šæœå°‹é é¢ -->
        <div id="pageSearch" class="space-y-6">
            <div class="bg-[#1e293b] rounded-2xl p-6 shadow-2xl border border-slate-700">
                <div class="relative">
                    <input type="text" id="searchInput"
                        class="w-full bg-slate-900 border-2 border-slate-700 rounded-xl px-5 py-4 text-lg focus:outline-none focus:border-sky-500 transition-all text-white pr-12"
                        placeholder="æœå°‹ä»£ç¢¼ã€ä¸­æ–‡æˆ–è‹±æ–‡é—œéµå­— (ä¾‹å¦‚ï¼šé«˜è¡€å£“ Pregnancy I10)...">
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500">
                        <kbd class="bg-slate-800 px-2 py-1 rounded text-xs border border-slate-700">ESC</kbd>
                    </div>
                </div>
                
                <div id="searchInfo" class="mt-3 text-sm text-slate-400 hidden">
                    æ‰¾åˆ° <span id="resultCount" class="text-sky-400 font-bold">0</span> ç­†çµæœ
                </div>

                <div id="searchTree" class="mt-8 space-y-6">
                    <!-- æœå°‹çµæœå°‡ä»¥æ¨¹ç‹€é¡¯ç¤º -->
                    <div class="text-center py-20 text-slate-600">
                        <div class="text-4xl mb-4">ğŸ©º</div>
                        <p>è«‹è¼¸å…¥è‡¨åºŠè¨ºæ–·é—œéµå­—æˆ–ä»£ç¢¼é–‹å§‹æŸ¥è©¢</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é ç±¤äºŒï¼šé¡åˆ¥ç€è¦½ -->
        <div id="pageCategory" class="hidden animate-fadeIn space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 id="currentCategoryTitle" class="text-3xl font-bold text-sky-400">è«‹é¸æ“‡é–‹é ­å­—æ¯</h2>
                <div class="flex gap-4">
                    <button onclick="expandAllGroups(true)" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg border border-slate-600 transition-colors">å…¨éƒ¨å±•é–‹</button>
                    <button onclick="expandAllGroups(false)" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg border border-slate-600 transition-colors">å…¨éƒ¨æ”¶åˆ</button>
                </div>
            </div>
            <div id="categoryTree" class="space-y-8">
                <!-- æ ¹æ“šé¸æ“‡å­—æ¯ç”Ÿæˆçš„æ¨¹ç‹€åˆ†æ”¯ -->
            </div>
        </div>

        <!-- é ç±¤ä¸‰ï¼šæˆ‘çš„æœ€æ„› -->
        <div id="pageFavorites" class="hidden animate-fadeIn space-y-6">
            <div class="bg-slate-900 border-2 border-sky-500/30 rounded-2xl p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-amber-400 flex items-center gap-2">â­ æˆ‘çš„æ”¶è—æ¸…å–®</h3>
                    <button onclick="clearAllFavorites()" class="text-xs text-slate-500 hover:text-red-400 transition-colors underline">æ¸…é™¤æ‰€æœ‰æ”¶è—</button>
                </div>
                <div id="favList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="noFavHint" class="text-center py-20 text-slate-500">
                    <p class="text-lg mb-2">å°šæœªæ”¶è—ä»»ä½•ä»£ç¢¼</p>
                    <p class="text-sm">åœ¨æœå°‹çµæœæˆ–é¡åˆ¥ä¸­é»æ“Šæ˜Ÿè™Ÿå³å¯æ”¶è—</p>
                </div>
            </div>
        </div>

        <div id="loading" class="py-20 text-center text-slate-500">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-sky-500 border-t-transparent mb-4"></div>
            <p class="text-lg">æ­£åœ¨è¼‰å…¥ ICD-10 è¨ºæ–·è³‡æ–™åº«...</p>
        </div>
    </div>
</div>

<!-- è¤‡è£½æç¤º -->
<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-sky-500 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all pointer-events-none z-50 font-bold scale-90">
    å·²è¤‡è£½ä»£ç¢¼ï¼
</div>

<script>
    const DATA_URL = 'https://raw.githubusercontent.com/Robloxcooper6666/ICD-10/main/icd10_codes_combined.json';
    let icdData = [];
    let favorites = JSON.parse(localStorage.getItem('icd_fav_tree_v2.2') || '[]');
    let currentLetter = '';

    // åˆå§‹åŒ–
    async function init() {
        try {
            const res = await fetch(DATA_URL);
            icdData = await res.json();
            
            // é è™•ç†è³‡æ–™ï¼Œå¢åŠ æœå°‹å„ªåŒ–çš„æ¨™è¨˜ï¼ˆå¦‚æœ JSON æ²’æœ‰ enï¼Œå‰‡è¦–ç‚ºç©ºå­—ä¸²ï¼‰
            icdData = icdData.map(item => ({
                ...item,
                en: item.en || '',
                searchBlob: `${item.code} ${item.zh} ${item.en || ''}`.toLowerCase()
            }));

            document.getElementById('loading').style.display = 'none';
            initLetterNav();
            switchTab('search');
            renderFavorites();
        } catch (err) {
            document.getElementById('loading').innerHTML = `
                <div class="text-red-400">
                    <p class="text-xl font-bold">è³‡æ–™è¼‰å…¥å¤±æ•—</p>
                    <p class="text-sm">è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦</p>
                </div>
            `;
        }
    }

    // åˆå§‹åŒ– A-Z å°è¦½
    function initLetterNav() {
        const nav = document.getElementById('letterNav');
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        nav.innerHTML = letters.map(l => `
            <button onclick="selectLetter('${l}')" class="letter-btn" id="btn-letter-${l}">${l}</button>
        `).join('');
    }

    // é¸æ“‡å­—æ¯
    function selectLetter(l) {
        currentLetter = l;
        document.querySelectorAll('.letter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-letter-${l}`);
        if(btn) btn.classList.add('active');
        document.getElementById('currentCategoryTitle').innerText = `é–‹é ­ç‚º ${l} çš„è¨ºæ–·é¡åˆ¥`;
        renderCategoryTree(l);
    }

    // é ç±¤åˆ‡æ›
    function switchTab(tab) {
        const pages = ['pageSearch', 'pageCategory', 'pageFavorites'];
        const tabs = ['tabSearch', 'tabCategory', 'tabFavs'];
        const letterNav = document.getElementById('letterNav');

        pages.forEach(p => document.getElementById(p).classList.add('hidden'));
        tabs.forEach(t => {
            const el = document.getElementById(t);
            el.classList.remove('tab-active');
            el.classList.add('text-slate-400');
        });

        if (tab === 'search') {
            document.getElementById('pageSearch').classList.remove('hidden');
            document.getElementById('tabSearch').classList.add('tab-active');
            document.getElementById('tabSearch').classList.remove('text-slate-400');
            letterNav.classList.add('hidden');
            document.getElementById('searchInput').focus();
        } else if (tab === 'category') {
            document.getElementById('pageCategory').classList.remove('hidden');
            document.getElementById('tabCategory').classList.add('tab-active');
            document.getElementById('tabCategory').classList.remove('text-slate-400');
            letterNav.classList.remove('hidden');
            if(!currentLetter) selectLetter('A');
        } else {
            document.getElementById('pageFavorites').classList.remove('hidden');
            document.getElementById('tabFavs').classList.add('tab-active');
            document.getElementById('tabFavs').classList.remove('text-slate-400');
            letterNav.classList.add('hidden');
            renderFavorites();
        }
    }

    // æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ï¼šæ¨¹ç‹€åˆ†æ”¯
    function buildTreeHTML(data, isSearch = false) {
        if (data.length === 0) return '<div class="text-center py-10 text-slate-500">æŸ¥ç„¡çµæœ</div>';
        
        const groups = {};
        data.forEach(item => {
            const mainKey = item.code.split('.')[0];
            if (!groups[mainKey]) groups[mainKey] = { main: null, children: [] };
            if (item.code === mainKey) groups[mainKey].main = item;
            else groups[mainKey].children.push(item);
        });

        const sortedKeys = Object.keys(groups).sort();
        return sortedKeys.map(key => {
            const group = groups[key];
            const main = group.main || { code: key, zh: "ç›¸é—œè¨ºæ–·åˆ†é¡", en: "" };
            const isFav = favorites.includes(main.code);

            return `
                <div class="category-group bg-slate-800/20 rounded-2xl border border-slate-700/50 p-5 overflow-hidden transition-all hover:border-slate-600">
                    <div class="flex items-start gap-4 cursor-pointer" onclick="handleAction('${main.code}', '${main.zh}')">
                        <button onclick="event.stopPropagation(); toggleFav('${main.code}')"
                                class="text-2xl text-slate-600 hover:text-amber-400 transition-colors ${isFav ? 'active-star' : ''}">â˜…</button>
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-pink-400 code-font">${main.code}</h4>
                            <p class="text-slate-100 font-medium">${main.zh}</p>
                            ${main.en ? `<p class="text-slate-500 text-xs mt-1 uppercase italic">${main.en}</p>` : ''}
                        </div>
                        <div class="text-slate-600 text-[10px] text-right">
                            ${group.children.length} å€‹å­ç´°é …
                        </div>
                    </div>

                    ${group.children.length > 0 ? `
                        <div class="mt-4 ml-10 space-y-3 branch-line">
                            ${group.children.map(sub => `
                                <div class="relative branch-item flex items-center gap-3 group" onclick="handleAction('${sub.code}', '${sub.zh}')">
                                    <button onclick="event.stopPropagation(); toggleFav('${sub.code}')"
                                            class="text-sm text-slate-600 hover:text-amber-400 transition-colors ${favorites.includes(sub.code) ? 'active-star' : ''}">â˜…</button>
                                    <div class="bg-slate-800/40 px-4 py-2 rounded-lg border border-slate-700/50 group-hover:border-sky-500/50 transition-all cursor-pointer flex-1">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <span class="code-font font-bold text-sky-400">${sub.code}</span>
                                                <span class="ml-3 text-slate-200">${sub.zh}</span>
                                            </div>
                                            <span class="text-[10px] text-slate-500 opacity-0 group-hover:opacity-100 italic transition-opacity">Copy</span>
                                        </div>
                                        ${sub.en ? `<div class="text-[10px] text-slate-500 mt-0.5 uppercase tracking-wide truncate max-w-[280px] md:max-w-none">${sub.en}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // é¡åˆ¥é é¢æ¸²æŸ“
    function renderCategoryTree(letter) {
        const container = document.getElementById('categoryTree');
        const filtered = icdData.filter(item => item.code.startsWith(letter));
        container.innerHTML = buildTreeHTML(filtered);
    }

    // æœå°‹åŠŸèƒ½ï¼šå„ªåŒ–å¤šé—œéµå­—èˆ‡ä¸­è‹±æ··åˆ
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        const tree = document.getElementById('searchTree');
        const info = document.getElementById('searchInfo');
        
        if (!query) { 
            tree.innerHTML = `
                <div class="text-center py-20 text-slate-600">
                    <div class="text-4xl mb-4">ğŸ©º</div>
                    <p>è«‹è¼¸å…¥è‡¨åºŠè¨ºæ–·é—œéµå­—æˆ–ä»£ç¢¼é–‹å§‹æŸ¥è©¢</p>
                </div>
            `; 
            info.classList.add('hidden');
            return; 
        }

        // åˆ†å‰²é—œéµå­—ï¼Œæ”¯æ´ä¸­è‹±æ··åˆ
        const keywords = query.split(/\s+/).filter(k => k.length > 0);

        const filtered = icdData.filter(item => {
            // å¿…é ˆåŒ…å«ã€Œæ‰€æœ‰ã€è¼¸å…¥çš„é—œéµå­— (AND é‚è¼¯)
            return keywords.every(kw => item.searchBlob.includes(kw));
        }).slice(0, 100); // æ“´å¤§æœå°‹ç¯„åœåˆ° 100 ç­†

        document.getElementById('resultCount').innerText = filtered.length;
        info.classList.remove('hidden');
        tree.innerHTML = buildTreeHTML(filtered, true);
    });

    // éµç›¤ç›£è½
    window.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
            const input = document.getElementById('searchInput');
            input.value = '';
            input.dispatchEvent(new Event('input'));
        }
    });

    // å±•é–‹/æ”¶åˆ
    function expandAllGroups(expand) {
        document.querySelectorAll('.branch-line').forEach(el => {
            el.style.display = expand ? 'block' : 'none';
        });
    }

    // è¡Œç‚ºè™•ç† (è¤‡è£½ä»£ç¢¼)
    function handleAction(code, zh) {
        const el = document.createElement('textarea');
        el.value = code;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);

        const toast = document.getElementById('toast');
        toast.innerText = `å·²è¤‡è£½: ${code}`;
        toast.style.opacity = '1';
        toast.classList.remove('scale-90');
        toast.classList.add('scale-100');
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.classList.remove('scale-100');
            toast.classList.add('scale-90');
        }, 1500);
    }

    // æˆ‘çš„æœ€æ„›é‚è¼¯
    function toggleFav(code) {
        const idx = favorites.indexOf(code);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push(code);
        localStorage.setItem('icd_fav_tree_v2.2', JSON.stringify(favorites));

        // å±€éƒ¨æ›´æ–°ç‹€æ…‹ï¼ˆæœå°‹èˆ‡é¡åˆ¥ç€è¦½ï¼‰
        const starBtns = document.querySelectorAll(`button[onclick*="'${code}'"]`);
        starBtns.forEach(btn => {
            if (favorites.includes(code)) btn.classList.add('active-star');
            else btn.classList.remove('active-star');
        });

        renderFavorites();
    }

    function clearAllFavorites() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—å—ï¼Ÿ')) {
            favorites = [];
            localStorage.setItem('icd_fav_tree_v2.2', JSON.stringify(favorites));
            location.reload();
        }
    }

    function renderFavorites() {
        const container = document.getElementById('favList');
        const hint = document.getElementById('noFavHint');
        
        if (favorites.length === 0) {
            container.innerHTML = '';
            hint.classList.remove('hidden');
            return;
        }
        hint.classList.add('hidden');

        // ä¿æŒæœ€æ„›æ¸…å–®æœ€æ–°è³‡è¨Š
        const favItems = favorites.map(code => {
            return icdData.find(i => i.code === code) || { code, zh: "å·²å¾åº«ä¸­ç§»é™¤", en: "" };
        });

        container.innerHTML = favItems.map(item => `
            <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700 flex justify-between items-center group cursor-pointer hover:bg-slate-800 transition-all" 
                 onclick="handleAction('${item.code}', '${item.zh}')">
                <div class="overflow-hidden">
                    <div class="code-font font-bold text-sky-400">${item.code}</div>
                    <div class="text-sm text-slate-100 truncate">${item.zh}</div>
                    ${item.en ? `<div class="text-[10px] text-slate-500 uppercase truncate">${item.en}</div>` : ''}
                </div>
                <button onclick="event.stopPropagation(); toggleFav('${item.code}')" class="ml-4 text-slate-500 hover:text-red-500 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        `).join('');
    }

    init();
</script>
</body>
</html>
